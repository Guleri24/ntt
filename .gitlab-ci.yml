image: golang:latest

stages:
  - test

test:
  stage: test
  script:
    - go test -coverprofile=coverage.out ./...
  coverage: '/coverage: \d+.\d+% of statements/'
  artifacts:
    when: always
    paths:
      - coverage.out
    expire_in: 1 hour

staticcheck:
  stage: test
  script:
    - go install honnef.co/go/tools/cmd/staticcheck@latest
    - staticcheck ./...

golang:1.16:
  image: golang:1.16
  stage: test
  script:
    - go test ./...

include:
   - template: Code-Quality.gitlab-ci.yml

code_quality:
  image: docker:stable
  services: # Disable Docker-in-Docker
  artifacts:
    paths: [gl-code-quality-report.json]
  rules:
    - if: $CODE_QUALITY_DISABLED
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

